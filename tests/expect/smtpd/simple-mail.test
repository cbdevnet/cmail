#!/usr/bin/expect -f

set mailfrom "sender@bar.baz" 
set mailto "recipient@bar.baz"
set subject "Simple mail from $mailfrom to $mailto"

source ../primitives/smtp_init

puts [exec reset_database]
exec cmail-admin-user add recipient recipient

send "MAIL FROM:<$mailfrom>\r"
expect "250 "

send "RCPT TO:<$mailto>\r"
expect "551 "

exec cmail-admin-address add "$mailto" recipient
exec cmail-admin-smtpd add recipient
exec cmail-admin-smtpd update inrouter recipient reject

send "RCPT TO:<$mailto>\r"
expect "551 "

exec cmail-admin-smtpd update inrouter recipient store

send "RCPT TO:<$mailto>\r"
expect "250 "

source ../primitives/smtp_data
