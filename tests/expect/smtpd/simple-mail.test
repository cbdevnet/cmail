#!/usr/bin/expect -f

set mailfrom "sender@bar.baz" 
set mailto "recipient@bar.baz"
set subject "Simple mail from $mailfrom to $mailto"

source ../primitives/common
source ../primitives/smtp_init

send -i $smtp "EHLO test-client\r"
expect -i $smtp "250 "

run reset_database

send "MAIL FROM:<$mailfrom>\r"
expect "250 "

send "RCPT TO:<$mailto>\r"
expect "551 "

run cmail-admin-address add "$mailto" reject "Foo Bar" 123

send "RCPT TO:<$mailto>\r"
expect "551 "

run cmail-admin-address update 123 drop

send "RCPT TO:<$mailto>\r"
expect "250 "

send "RCPT TO:<$mailto>\r"
expect "250 "

source ../primitives/smtp_data

send "RSET\r"
expect "250 "

send "MAIL FROM:<$mailfrom>\r"
expect "250 "

send "RCPT TO:<$mailto>\r"
expect "250 "

source ../primitives/smtp_data
